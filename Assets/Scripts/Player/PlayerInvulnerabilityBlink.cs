using UnityEngine;

/// Parpadeo suave (fade de alpha) durante invulnerabilidad.
/// ✅ Robusto en móvil / anuncios reales.
/// ✅ No depende de timeScale.
/// ✅ Reacciona correctamente a cambios de estado.
public class PlayerInvulnerabilityFadeBlink : MonoBehaviour
{
    [Header("References")]
    [SerializeField] private SpriteRenderer sprite;

    [Header("Fade Blink Settings")]
    [Tooltip("Velocidad del parpadeo (más alto = más rápido).")]
    [SerializeField] private float blinkSpeed = 8f;

    [Tooltip("Alpha mínimo durante el parpadeo.")]
    [Range(0f, 1f)]
    [SerializeField] private float minAlpha = 0.25f;

    // Color original del sprite (para restaurar)
    private Color baseColor;

    // Estado previo para detectar cambios (enter / exit invul)
    private bool wasInvulnerable = false;

    private void Awake()
    {
        // Auto-assign si no se puso en Inspector
        if (sprite == null)
            sprite = GetComponentInChildren<SpriteRenderer>();

        // Guardamos el color original
        if (sprite != null)
            baseColor = sprite.color;
    }

    private void Update()
    {
        if (sprite == null || GameManager.Instance == null)
            return;

        bool isInvulnerable = GameManager.Instance.IsReviveInvulnerable;

        // -------------------------------------------------
        // ENTRADA A INVULNERABILIDAD
        // -------------------------------------------------
        if (isInvulnerable && !wasInvulnerable)
        {
            // Forzamos un alpha visible inicial
            SetAlpha(1f);
        }

        // -------------------------------------------------
        // SALIDA DE INVULNERABILIDAD
        // -------------------------------------------------
        if (!isInvulnerable && wasInvulnerable)
        {
            // Restauramos alpha normal
            RestoreAlpha();
        }

        // -------------------------------------------------
        // PARPADEO (solo mientras invulnerable)
        // -------------------------------------------------
        if (isInvulnerable)
        {
            // Tiempo REAL (no depende de Time.timeScale)
            float t = Time.unscaledTime * blinkSpeed;

            // Oscilación suave 0..1
            float s = (Mathf.Sin(t) + 1f) * 0.5f;

            // Interpolamos alpha
            float alpha = Mathf.Lerp(minAlpha, baseColor.a, s);
            SetAlpha(alpha);
        }

        // Guardamos estado para el siguiente frame
        wasInvulnerable = isInvulnerable;
    }

    private void SetAlpha(float a)
    {
        var c = sprite.color;
        c.a = a;
        sprite.color = c;
    }

    private void RestoreAlpha()
    {
        sprite.color = baseColor;
    }

    private void OnDisable()
    {
        // Seguridad: nunca dejar el sprite semitransparente
        if (sprite != null)
            sprite.color = baseColor;
    }
}
